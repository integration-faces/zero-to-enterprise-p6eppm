#!/bin/bash
#===============================================================================
# Environment Validation Script
# Pre-flight checks for WebLogic domain creation
#
# Generated by WebLogic Domain Automation Phase 2
# Configuration: {{CONFIG_FILE}}
#===============================================================================

set -o pipefail

# Color codes
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

# Configuration
JAVA_HOME="{{DOMAIN_JAVA_HOME}}"
WEBLOGIC_HOME="{{DOMAIN_WEBLOGIC_HOME}}"
MIDDLEWARE_HOME="{{DOMAIN_MIDDLEWARE_HOME}}"
DOMAIN_HOME="{{DOMAIN_DOMAIN_HOME}}"
DOMAIN_NAME="{{DOMAIN_DOMAIN_NAME}}"

# Hosts to check
HOSTS=({{HOSTS_LIST}})

# Ports to check
ADMIN_PORT={{DOMAIN_ADMIN_PORT}}
NM_PORT={{NODEMANAGER_LISTEN_PORT}}

#===============================================================================
# Validation Functions
#===============================================================================

ERRORS=0
WARNINGS=0

check_pass() {
    echo -e "${GREEN}[PASS]${NC} $1"
}

check_fail() {
    echo -e "${RED}[FAIL]${NC} $1"
    ((ERRORS++))
}

check_warn() {
    echo -e "${YELLOW}[WARN]${NC} $1"
    ((WARNINGS++))
}

#-------------------------------------------------------------------------------
# Java Validation
#-------------------------------------------------------------------------------
check_java() {
    echo ""
    echo "=== Java Environment ==="
    
    if [[ ! -d "${JAVA_HOME}" ]]; then
        check_fail "JAVA_HOME not found: ${JAVA_HOME}"
        return
    fi
    
    if [[ ! -x "${JAVA_HOME}/bin/java" ]]; then
        check_fail "Java executable not found: ${JAVA_HOME}/bin/java"
        return
    fi
    
    check_pass "JAVA_HOME exists: ${JAVA_HOME}"
    
    # Check Java version
    local java_version=$("${JAVA_HOME}/bin/java" -version 2>&1 | head -n1)
    echo "      Java version: ${java_version}"
    
    # Verify minimum Java version (1.8)
    local version_num=$("${JAVA_HOME}/bin/java" -version 2>&1 | grep -oP 'version "?\K[0-9]+' | head -1)
    if [[ ${version_num} -lt 8 && ${version_num} -ne 1 ]]; then
        check_warn "Java version may be too old (requires 1.8 or higher)"
    fi
}

#-------------------------------------------------------------------------------
# WebLogic Validation
#-------------------------------------------------------------------------------
check_weblogic() {
    echo ""
    echo "=== WebLogic Installation ==="
    
    if [[ ! -d "${WEBLOGIC_HOME}" ]]; then
        check_fail "WebLogic Home not found: ${WEBLOGIC_HOME}"
        return
    fi
    check_pass "WebLogic Home exists: ${WEBLOGIC_HOME}"
    
    if [[ ! -d "${MIDDLEWARE_HOME}" ]]; then
        check_fail "Middleware Home not found: ${MIDDLEWARE_HOME}"
        return
    fi
    check_pass "Middleware Home exists: ${MIDDLEWARE_HOME}"
    
    # Check for WLST
    local wlst_script="${MIDDLEWARE_HOME}/oracle_common/common/bin/wlst.sh"
    if [[ ! -x "${wlst_script}" ]]; then
        wlst_script="${WEBLOGIC_HOME}/common/bin/wlst.sh"
    fi
    
    if [[ -x "${wlst_script}" ]]; then
        check_pass "WLST found: ${wlst_script}"
    else
        check_fail "WLST script not found"
    fi
    
    # Check for domain template
    local template="${WEBLOGIC_HOME}/common/templates/wls/wls.jar"
    if [[ -f "${template}" ]]; then
        check_pass "Domain template found: ${template}"
    else
        check_fail "Domain template not found: ${template}"
    fi
}

#-------------------------------------------------------------------------------
# Domain Path Validation
#-------------------------------------------------------------------------------
check_domain_path() {
    echo ""
    echo "=== Domain Path ==="
    
    local domain_parent=$(dirname "${DOMAIN_HOME}")
    
    if [[ -d "${DOMAIN_HOME}" ]]; then
        check_warn "Domain already exists: ${DOMAIN_HOME}"
    else
        if [[ -d "${domain_parent}" ]]; then
            check_pass "Domain parent directory exists: ${domain_parent}"
        else
            check_warn "Domain parent directory does not exist: ${domain_parent}"
            echo "      Will be created during domain creation"
        fi
    fi
    
    # Check write permissions
    local check_dir="${domain_parent}"
    while [[ ! -d "${check_dir}" && "${check_dir}" != "/" ]]; do
        check_dir=$(dirname "${check_dir}")
    done
    
    if [[ -w "${check_dir}" ]]; then
        check_pass "Write permission available: ${check_dir}"
    else
        check_fail "No write permission: ${check_dir}"
    fi
}

#-------------------------------------------------------------------------------
# Disk Space Validation
#-------------------------------------------------------------------------------
check_disk_space() {
    echo ""
    echo "=== Disk Space ==="
    
    local check_path=$(dirname "${DOMAIN_HOME}")
    while [[ ! -d "${check_path}" && "${check_path}" != "/" ]]; do
        check_path=$(dirname "${check_path}")
    done
    
    local free_space=$(df -BG "${check_path}" 2>/dev/null | awk 'NR==2 {print $4}' | tr -d 'G')
    
    if [[ -n "${free_space}" ]]; then
        echo "      Free space: ${free_space}GB on ${check_path}"
        
        if [[ ${free_space} -lt 1 ]]; then
            check_fail "Insufficient disk space (need at least 1GB)"
        elif [[ ${free_space} -lt 5 ]]; then
            check_warn "Low disk space (recommend at least 5GB)"
        else
            check_pass "Sufficient disk space available"
        fi
    else
        check_warn "Could not determine disk space"
    fi
}

#-------------------------------------------------------------------------------
# Port Availability Validation
#-------------------------------------------------------------------------------
check_ports() {
    echo ""
    echo "=== Port Availability ==="
    
    # Check admin port
    if command -v ss &>/dev/null; then
        if ss -tuln | grep -q ":${ADMIN_PORT} "; then
            check_warn "Admin port ${ADMIN_PORT} appears to be in use"
        else
            check_pass "Admin port ${ADMIN_PORT} is available"
        fi
        
        if ss -tuln | grep -q ":${NM_PORT} "; then
            check_warn "Node Manager port ${NM_PORT} appears to be in use"
        else
            check_pass "Node Manager port ${NM_PORT} is available"
        fi
    elif command -v netstat &>/dev/null; then
        if netstat -tuln | grep -q ":${ADMIN_PORT} "; then
            check_warn "Admin port ${ADMIN_PORT} appears to be in use"
        else
            check_pass "Admin port ${ADMIN_PORT} is available"
        fi
        
        if netstat -tuln | grep -q ":${NM_PORT} "; then
            check_warn "Node Manager port ${NM_PORT} appears to be in use"
        else
            check_pass "Node Manager port ${NM_PORT} is available"
        fi
    else
        check_warn "Cannot check port availability (no ss or netstat)"
    fi
}

#-------------------------------------------------------------------------------
# Host Connectivity Validation (for multi-host)
#-------------------------------------------------------------------------------
check_hosts() {
    echo ""
    echo "=== Host Connectivity ==="
    
    if [[ ${#HOSTS[@]} -le 1 ]]; then
        check_pass "Single-host deployment - no remote connectivity needed"
        return
    fi
    
    for host in "${HOSTS[@]}"; do
        if ping -c 1 -W 2 "${host}" &>/dev/null; then
            check_pass "Host reachable: ${host}"
        else
            check_warn "Host not reachable: ${host}"
        fi
    done
}

#-------------------------------------------------------------------------------
# User and Permissions Validation
#-------------------------------------------------------------------------------
check_user() {
    echo ""
    echo "=== User and Permissions ==="
    
    local current_user=$(whoami)
    echo "      Current user: ${current_user}"
    
    if [[ "${current_user}" == "root" ]]; then
        check_warn "Running as root is not recommended"
    else
        check_pass "Not running as root"
    fi
    
    # Check umask
    local current_umask=$(umask)
    echo "      Current umask: ${current_umask}"
}

#===============================================================================
# Main Execution
#===============================================================================

echo "========================================"
echo " WebLogic Environment Validation"
echo " Domain: ${DOMAIN_NAME}"
echo "========================================"

check_java
check_weblogic
check_domain_path
check_disk_space
check_ports
check_hosts
check_user

echo ""
echo "========================================"
echo " Validation Summary"
echo "========================================"
echo "  Errors:   ${ERRORS}"
echo "  Warnings: ${WARNINGS}"
echo ""

if [[ ${ERRORS} -gt 0 ]]; then
    echo -e "${RED}Validation FAILED${NC} - fix errors before proceeding"
    exit 2
elif [[ ${WARNINGS} -gt 0 ]]; then
    echo -e "${YELLOW}Validation PASSED with warnings${NC}"
    exit 0
else
    echo -e "${GREEN}Validation PASSED${NC}"
    exit 0
fi
