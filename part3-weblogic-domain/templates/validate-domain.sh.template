#!/bin/bash
#===============================================================================
# Domain Validation Script
# Post-creation verification for WebLogic domain
#
# Generated by WebLogic Domain Automation Phase 2
#===============================================================================

set -o pipefail

# Color codes
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
NC='\033[0m'

# Configuration
DOMAIN_NAME="{{DOMAIN_DOMAIN_NAME}}"
DOMAIN_HOME="{{DOMAIN_DOMAIN_HOME}}"
ADMIN_SERVER_NAME="{{DOMAIN_ADMIN_SERVER_NAME}}"
ADMIN_PORT={{DOMAIN_ADMIN_PORT}}
ADMIN_USER="{{DOMAIN_ADMIN_USER}}"
JAVA_HOME="{{DOMAIN_JAVA_HOME}}"
MIDDLEWARE_HOME="{{DOMAIN_MIDDLEWARE_HOME}}"

# Options
TEST_START=false
VERBOSE=false

#===============================================================================
# Parse Arguments
#===============================================================================

while [[ $# -gt 0 ]]; do
    case "$1" in
        --test-start)
            TEST_START=true
            shift
            ;;
        --verbose)
            VERBOSE=true
            shift
            ;;
        --help)
            echo "Usage: $0 [OPTIONS]"
            echo ""
            echo "Options:"
            echo "  --test-start    Attempt to start Admin Server"
            echo "  --verbose       Show detailed output"
            echo "  --help          Show this help"
            exit 0
            ;;
        *)
            echo "Unknown option: $1"
            exit 1
            ;;
    esac
done

#===============================================================================
# Validation Functions
#===============================================================================

ERRORS=0
WARNINGS=0

check_pass() {
    echo -e "${GREEN}[PASS]${NC} $1"
}

check_fail() {
    echo -e "${RED}[FAIL]${NC} $1"
    ((ERRORS++))
}

check_warn() {
    echo -e "${YELLOW}[WARN]${NC} $1"
    ((WARNINGS++))
}

check_info() {
    echo -e "${CYAN}[INFO]${NC} $1"
}

#-------------------------------------------------------------------------------
# Domain Structure Validation
#-------------------------------------------------------------------------------
check_domain_structure() {
    echo ""
    echo "=== Domain Structure ==="
    
    if [[ ! -d "${DOMAIN_HOME}" ]]; then
        check_fail "Domain home does not exist: ${DOMAIN_HOME}"
        return 1
    fi
    check_pass "Domain home exists: ${DOMAIN_HOME}"
    
    # Check essential directories
    local required_dirs=(
        "bin"
        "config"
        "servers"
    )
    
    for dir in "${required_dirs[@]}"; do
        if [[ -d "${DOMAIN_HOME}/${dir}" ]]; then
            check_pass "Directory exists: ${dir}/"
        else
            check_fail "Directory missing: ${dir}/"
        fi
    done
    
    # Check essential files
    local required_files=(
        "config/config.xml"
        "bin/startWebLogic.sh"
        "bin/stopWebLogic.sh"
    )
    
    for file in "${required_files[@]}"; do
        if [[ -f "${DOMAIN_HOME}/${file}" ]]; then
            check_pass "File exists: ${file}"
        else
            check_fail "File missing: ${file}"
        fi
    done
}

#-------------------------------------------------------------------------------
# Configuration XML Validation
#-------------------------------------------------------------------------------
check_config_xml() {
    echo ""
    echo "=== Configuration Validation ==="
    
    local config_xml="${DOMAIN_HOME}/config/config.xml"
    
    if [[ ! -f "${config_xml}" ]]; then
        check_fail "config.xml not found"
        return 1
    fi
    
    # Check domain name
    if grep -q "<name>${DOMAIN_NAME}</name>" "${config_xml}"; then
        check_pass "Domain name in config.xml: ${DOMAIN_NAME}"
    else
        check_fail "Domain name mismatch in config.xml"
    fi
    
    # Check Admin Server
    if grep -q "<name>${ADMIN_SERVER_NAME}</name>" "${config_xml}"; then
        check_pass "Admin Server defined: ${ADMIN_SERVER_NAME}"
    else
        check_warn "Admin Server name not found in config.xml"
    fi
    
    # Count servers
    local server_count=$(grep -c "<server>" "${config_xml}" 2>/dev/null || echo 0)
    check_info "Servers defined: ${server_count}"
    
    # Count machines
    local machine_count=$(grep -c "<machine>" "${config_xml}" 2>/dev/null || echo 0)
    check_info "Machines defined: ${machine_count}"
    
    # Count clusters
    local cluster_count=$(grep -c "<cluster>" "${config_xml}" 2>/dev/null || echo 0)
    check_info "Clusters defined: ${cluster_count}"
    
    # Validate XML well-formedness (basic check)
    if command -v xmllint &>/dev/null; then
        if xmllint --noout "${config_xml}" 2>/dev/null; then
            check_pass "config.xml is well-formed XML"
        else
            check_fail "config.xml has XML syntax errors"
        fi
    fi
}

#-------------------------------------------------------------------------------
# Server Directories Validation
#-------------------------------------------------------------------------------
check_server_directories() {
    echo ""
    echo "=== Server Directories ==="
    
    local servers_dir="${DOMAIN_HOME}/servers"
    
    if [[ ! -d "${servers_dir}" ]]; then
        check_fail "Servers directory not found"
        return 1
    fi
    
    # Check Admin Server directory
    if [[ -d "${servers_dir}/${ADMIN_SERVER_NAME}" ]]; then
        check_pass "Admin Server directory: ${ADMIN_SERVER_NAME}/"
    else
        check_info "Admin Server directory will be created on first start"
    fi
    
    # Check for boot.properties
    local boot_props="${servers_dir}/${ADMIN_SERVER_NAME}/security/boot.properties"
    if [[ -f "${boot_props}" ]]; then
        check_pass "boot.properties exists for ${ADMIN_SERVER_NAME}"
        
        # Check permissions
        local perms=$(stat -c "%a" "${boot_props}" 2>/dev/null)
        if [[ "${perms}" == "600" ]]; then
            check_pass "boot.properties has secure permissions (600)"
        else
            check_warn "boot.properties permissions are ${perms} (should be 600)"
        fi
    else
        check_info "boot.properties not found (optional)"
    fi
    
    # List managed server directories
    if [[ "${VERBOSE}" == "true" ]]; then
        echo ""
        echo "  Server directories found:"
        find "${servers_dir}" -maxdepth 1 -type d ! -name "servers" 2>/dev/null | while read dir; do
            if [[ -n "${dir}" ]]; then
                echo "    - $(basename "${dir}")"
            fi
        done
    fi
}

#-------------------------------------------------------------------------------
# Node Manager Validation
#-------------------------------------------------------------------------------
check_nodemanager() {
    echo ""
    echo "=== Node Manager Configuration ==="
    
    local nm_home="${DOMAIN_HOME}/nodemanager"
    
    if [[ ! -d "${nm_home}" ]]; then
        check_warn "Node Manager directory not found: ${nm_home}"
        return
    fi
    check_pass "Node Manager directory exists"
    
    # Check nodemanager.properties
    if [[ -f "${nm_home}/nodemanager.properties" ]]; then
        check_pass "nodemanager.properties exists"
        
        # Verify key settings
        local nm_port=$(grep "^ListenPort=" "${nm_home}/nodemanager.properties" | cut -d= -f2)
        local secure=$(grep "^SecureListener=" "${nm_home}/nodemanager.properties" | cut -d= -f2)
        
        if [[ -n "${nm_port}" ]]; then
            check_info "Node Manager port: ${nm_port}"
            if [[ "${nm_port}" != "5556" ]]; then
                check_warn "Non-standard Node Manager port (standard is 5556)"
            fi
        fi
        
        if [[ "${secure}" == "true" ]]; then
            check_info "Node Manager security: SSL enabled"
        else
            check_info "Node Manager security: PLAIN (non-SSL)"
        fi
    else
        check_warn "nodemanager.properties not found"
    fi
    
    # Check nodemanager.domains
    if [[ -f "${nm_home}/nodemanager.domains" ]]; then
        check_pass "nodemanager.domains exists"
        if grep -q "${DOMAIN_NAME}=" "${nm_home}/nodemanager.domains"; then
            check_pass "Domain registered in nodemanager.domains"
        else
            check_warn "Domain not registered in nodemanager.domains"
        fi
    else
        check_warn "nodemanager.domains not found"
    fi
}

#-------------------------------------------------------------------------------
# Start Scripts Validation
#-------------------------------------------------------------------------------
check_start_scripts() {
    echo ""
    echo "=== Start Scripts ==="
    
    local scripts=(
        "bin/startWebLogic.sh"
        "bin/stopWebLogic.sh"
        "bin/setDomainEnv.sh"
    )
    
    for script in "${scripts[@]}"; do
        local script_path="${DOMAIN_HOME}/${script}"
        if [[ -f "${script_path}" ]]; then
            if [[ -x "${script_path}" ]]; then
                check_pass "Executable: ${script}"
            else
                check_warn "Not executable: ${script}"
            fi
        else
            check_warn "Missing: ${script}"
        fi
    done
}

#-------------------------------------------------------------------------------
# Optional: Test Admin Server Start
#-------------------------------------------------------------------------------
test_admin_start() {
    echo ""
    echo "=== Admin Server Start Test ==="
    
    if [[ "${TEST_START}" != "true" ]]; then
        check_info "Start test skipped (use --test-start to enable)"
        return
    fi
    
    check_info "Attempting to start Admin Server..."
    
    # Set environment
    export JAVA_HOME="${JAVA_HOME}"
    export MW_HOME="${MIDDLEWARE_HOME}"
    
    # Start in background
    cd "${DOMAIN_HOME}"
    nohup ./bin/startWebLogic.sh > /tmp/wls_start_test.log 2>&1 &
    local start_pid=$!
    
    # Wait for startup (max 120 seconds)
    local timeout=120
    local elapsed=0
    local started=false
    
    echo "  Waiting for Admin Server to start (timeout: ${timeout}s)..."
    
    while [[ ${elapsed} -lt ${timeout} ]]; do
        if grep -q "Server state changed to RUNNING" /tmp/wls_start_test.log 2>/dev/null; then
            started=true
            break
        fi
        
        if ! kill -0 ${start_pid} 2>/dev/null; then
            # Process exited
            if grep -q "Error" /tmp/wls_start_test.log 2>/dev/null; then
                break
            fi
        fi
        
        sleep 5
        ((elapsed += 5))
        echo "  ... ${elapsed}s"
    done
    
    if [[ "${started}" == "true" ]]; then
        check_pass "Admin Server started successfully"
        
        # Test HTTP connectivity
        if command -v curl &>/dev/null; then
            local http_code=$(curl -s -o /dev/null -w "%{http_code}" "http://localhost:${ADMIN_PORT}/console" 2>/dev/null)
            if [[ "${http_code}" == "200" || "${http_code}" == "302" ]]; then
                check_pass "Admin Console accessible (HTTP ${http_code})"
            else
                check_warn "Admin Console returned HTTP ${http_code}"
            fi
        fi
        
        # Stop the server
        echo "  Stopping Admin Server..."
        "${DOMAIN_HOME}/bin/stopWebLogic.sh" >/dev/null 2>&1 &
        sleep 10
    else
        check_fail "Admin Server failed to start"
        echo ""
        echo "  Last 20 lines of startup log:"
        tail -20 /tmp/wls_start_test.log 2>/dev/null | sed 's/^/    /'
    fi
    
    # Cleanup
    rm -f /tmp/wls_start_test.log
}

#===============================================================================
# Main Execution
#===============================================================================

echo "========================================"
echo " WebLogic Domain Validation"
echo " Domain: ${DOMAIN_NAME}"
echo " Location: ${DOMAIN_HOME}"
echo "========================================"

check_domain_structure
check_config_xml
check_server_directories
check_nodemanager
check_start_scripts
test_admin_start

echo ""
echo "========================================"
echo " Validation Summary"
echo "========================================"
echo "  Errors:   ${ERRORS}"
echo "  Warnings: ${WARNINGS}"
echo ""

if [[ ${ERRORS} -gt 0 ]]; then
    echo -e "${RED}Validation FAILED${NC}"
    exit 2
elif [[ ${WARNINGS} -gt 0 ]]; then
    echo -e "${YELLOW}Validation PASSED with warnings${NC}"
    exit 0
else
    echo -e "${GREEN}Validation PASSED${NC}"
    exit 0
fi
